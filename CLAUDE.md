# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is an STM32F103C8T6 (Cortex-M3) embedded project generated by STM32CubeIDE for Visual Studio Code Extension. The target MCU has:
- 64KB Flash memory
- 20KB RAM
- No FPU, No DSP, No MVE
- ARM Cortex-M3 core

## Build System

This project uses CMake with Ninja generator and the GNU Tools for STM32 toolchain (arm-none-eabi-gcc).

### Build Commands

**Recommended: Using CMake Presets**
```bash
# Configure and build (Debug)
cmake --preset Debug
cmake --build --preset Debug

# Configure and build (Release)
cmake --preset Release
cmake --build --preset Release
```

**Alternative: Manual CMake Configuration**

If your IDE (like CLion) doesn't use CMake Presets, you must specify the toolchain file:
```bash
# Debug build
cmake -DCMAKE_BUILD_TYPE=Debug \
      -DCMAKE_TOOLCHAIN_FILE=cmake/gnu-tools-for-stm32.cmake \
      -G Ninja \
      -S . -B cmake-build-debug

cmake --build cmake-build-debug

# Release build
cmake -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_TOOLCHAIN_FILE=cmake/gnu-tools-for-stm32.cmake \
      -G Ninja \
      -S . -B cmake-build-release

cmake --build cmake-build-release
```

**Important:** Without the toolchain file, CMake will use the system compiler (AppleClang/GCC) instead of the ARM cross-compiler, which will fail to build for STM32.

### Build Outputs

- `test32.elf` - Executable with debug symbols
- `test32.hex` - Intel HEX format for flashing
- `test32.bin` - Raw binary format for flashing
- `test32.map` - Memory map file

Build artifacts are located in:
- `build/Debug/` or `build/Release/` (when using presets)
- `cmake-build-debug/` or `cmake-build-release/` (manual configuration)

## Project Structure

### Source Organization

- `Src/` - Application source code
  - `main.c` - Main application entry point
  - `syscall.c` - System call implementations
  - `sysmem.c` - Memory management syscalls
  - `startup_stm32f103xx.S` - Assembly startup code and interrupt vectors

- `Inc/` - Application header files (currently empty)

### Build Configuration

- `CMakeLists.txt` - User-modifiable CMake configuration
- `CMakePresets.json` - Build presets (Debug/Release configurations)
- `cmake/vscode_generated.cmake` - Auto-generated by STM32CubeIDE (do not modify)
- `cmake/gnu-tools-for-stm32.cmake` - Toolchain file defining ARM GCC compiler settings
- `stm32f103x8_flash.ld` - Linker script defining memory layout

### Key Build Settings

- C Standard: C11
- C++ Standard: C++20
- Debug build: `-O0 -g3 -ggdb`
- Release build: `-Os` (optimize for size)
- Float printf support enabled via `-u _printf_float`
- Memory sections enabled: `-fdata-sections -ffunction-sections -Wl,--gc-sections`

## Architecture Notes

### CMake Build Flow

1. `CMakeLists.txt` defines user-configurable settings and sources
2. Includes `cmake/vscode_generated.cmake` which adds auto-generated configuration
3. `cmake/gnu-tools-for-stm32.cmake` (toolchain file) sets up ARM cross-compilation
4. CPU flags are determined from `CMSIS_Dcore` variable (set to Cortex-M3)
5. Post-build commands generate `.hex` and `.bin` files automatically

### Memory Layout

Defined in `stm32f103x8_flash.ld`:
- Flash: 0x08000000, 64KB
- RAM: 0x20000000, 20KB
- Minimum heap: 512 bytes (0x200)
- Minimum stack: 1024 bytes (0x400)

### Startup Flow

1. `startup_stm32f103xx.S` defines Reset_Handler and interrupt vector table
2. Reset_Handler initializes data/bss sections
3. Calls `main()` from `Src/main.c`
4. Default implementation enters infinite loop

## Development Workflow

### Adding New Source Files

Add to `sources_SRCS` in `CMakeLists.txt`:
```cmake
set(sources_SRCS
    ${CMAKE_CURRENT_SOURCE_DIR}/Src/main.c
    ${CMAKE_CURRENT_SOURCE_DIR}/Src/your_new_file.c
)
```

### Adding Include Directories

Add to `include_DIRS` in `CMakeLists.txt`:
```cmake
set(include_DIRS
    ${CMAKE_CURRENT_SOURCE_DIR}/Inc
    ${CMAKE_CURRENT_SOURCE_DIR}/your_new_include_dir
)
```

### Adding Compile Definitions

Add to `symbols_SYMB` in `CMakeLists.txt` for all languages, or use language-specific variables (`symbols_c_SYMB`, `symbols_cxx_SYMB`).

## Important Constraints

- **Do not modify** `cmake/vscode_generated.cmake` - this is auto-generated by STM32CubeIDE
- The project uses `nosys.specs` - no operating system support
- Toolchain must be `arm-none-eabi-gcc` (GNU Tools for STM32)
- The project expects STM32Cube tools installed (cube-cmake, cube-clangd)
